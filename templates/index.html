{% extends 'base.html' %}

{% block content %}
<div class="row align-items-center mb-4">
    <div class="col">
        <h2 class="page-title mb-0">Task Dashboard</h2>
    </div>
    <div class="col-auto">
        <a href="/add" class="btn btn-primary shadow-sm">
            <i class="fas fa-plus"></i> Add Task
        </a>
    </div>
</div>

<div class="card p-3 shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover align-middle" id="taskTable">
            <thead class="table-light">
                <tr>
                    <th scope="col">Title</th>
                    <th scope="col">Description</th>
                    <th scope="col">Due Date</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
    
    <div id="loading" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div id="noTasks" class="text-center py-4 text-muted" style="display:none;">
        <i class="fas fa-clipboard-list fa-3x mb-3 text-secondary"></i>
        <p>No tasks found. Start by adding one!</p>
    </div>
</div>

<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="editTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="editDueDate">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editStatus">
                            <option value="Pending">Pending</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTaskChanges()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize the Bootstrap Modal
    let editModal;
    document.addEventListener('DOMContentLoaded', () => {
        editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
        loadTasks();
    });

    // 1. Load Tasks (Read)
    function loadTasks() {
        fetch('/api/tasks')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#taskTable tbody');
                const loading = document.getElementById('loading');
                const noTasks = document.getElementById('noTasks');

                loading.style.display = 'none';
                tbody.innerHTML = '';

                if (data.length === 0) {
                    noTasks.style.display = 'block';
                    return;
                }
                
                noTasks.style.display = 'none';

                data.forEach(task => {
                    const row = `
                        <tr>
                            <td class="fw-bold">${task.title}</td>
                            <td class="text-muted small">${task.description}</td>
                            <td>
                                <i class="far fa-calendar-alt me-1 text-secondary"></i>
                                ${task.due_date || '-'}
                            </td>
                            <td>${getStatusBadge(task.status)}</td>
                            <td class="text-end">
                                <button class="btn btn-outline-primary btn-action btn-sm" onclick="openEditModal(${task.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-action btn-sm" onclick="deleteTask(${task.id})" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => console.error('Error:', error));
    }

    // Helper for Badges
    function getStatusBadge(status) {
        let badgeClass = 'bg-secondary';
        if (status === 'Completed') badgeClass = 'bg-success';
        if (status === 'In Progress') badgeClass = 'bg-warning text-dark';
        return `<span class="badge ${badgeClass} status-badge">${status}</span>`;
    }

    // 2. Open Edit Modal (Prefill Data)
    function openEditModal(id) {
        // Fetch the single task details from API
        fetch(`/api/tasks/${id}`)
            .then(response => response.json())
            .then(task => {
                if(task.error) {
                    alert('Error fetching task details');
                    return;
                }
                
                // Fill the modal fields with existing data
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTitle').value = task.title;
                document.getElementById('editDescription').value = task.description;
                document.getElementById('editDueDate').value = task.due_date;
                document.getElementById('editStatus').value = task.status;

                // Show the modal
                editModal.show();
            })
            .catch(err => console.error(err));
    }

    // 3. Save Changes (Update)
    function saveTaskChanges() {
        const id = document.getElementById('editTaskId').value;
        const data = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDescription').value,
            due_date: document.getElementById('editDueDate').value,
            status: document.getElementById('editStatus').value
        };

        fetch(`/api/tasks/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                editModal.hide(); // Close modal
                loadTasks();      // Refresh list to show changes
            } else {
                alert('Failed to update task');
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // 4. Delete Task
    function deleteTask(id) {
        if(confirm('Are you sure you want to delete this task?')) {
            fetch(`/api/tasks/${id}`, { method: 'DELETE' })
                .then(response => {
                    if(response.ok) loadTasks();
                    else alert('Failed to delete');
                });
        }
    }
</script>
{% endblock %}